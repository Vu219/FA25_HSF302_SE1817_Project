<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ho√†n t·∫•t thanh to√°n</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* CSS n·ªôi tuy·∫øn cho trang thanh to√°n */
        body { background-color: #f4f7fa; }
        .payment-container {
            max-width: 800px;
            margin: 120px auto 40px auto; /* Th√™m margin-top ƒë·ªÉ kh√¥ng b·ªã header che */
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            color: #333;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .booking-summary {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 30px;
        }
        .booking-summary h3 { margin-top: 0; color: #333; }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .info-label { font-weight: bold; color: #666; }
        .info-value { color: #333; }
        .total-amount {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #e7f3ff;
            border-radius: 4px;
        }
        .payment-button {
            width: 100%;
            background-color: #28a745;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 4px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }
        .payment-button:hover { background-color: #218838; }
        .payment-button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .ticket-list { margin-top: 15px; }
        .ticket-item {
            background-color: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #28a745;
        }
        .loading { text-align: center; color: #666; }
    </style>
</head>
<body>

<header>
    <nav class="navbar container">
        <a th:href="@{/home}" class="logo">
            <i class="fas fa-train"></i> EVTrainTicket
        </a>
        <div class="nav-links" th:if="${session.user == null}">
            <a th:href="@{/login}">ƒêƒÉng nh·∫≠p</a>
            <a th:href="@{/register}">ƒêƒÉng k√Ω</a>
        </div>

        <div class="user-info" th:if="${session.user != null}">
            <p>Xin ch√†o, <strong th:text="${session.user.fullName}"></strong>!</p>

            <a th:href="@{/booking/history}" class="admin-nav-link" style="background-color: #28a745; border-color: #28a745;">
                <i class="fas fa-history"></i> V√© c·ªßa t√¥i
            </a>

            <a th:if="${session.user.role == 'ADMIN'}" th:href="@{/admin}" class="admin-nav-link">
                <i class="fas fa-cogs"></i> Qu·∫£n tr·ªã
            </a>

            <form th:action="@{/logout}" method="get" style="margin: 0;">
                <button type="submit">
                    <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                </button>
            </form>
        </div>
    </nav>
</header>

<main>
    <div class="payment-container">
        <div class="header">
            <h1>üé´ Ho√†n t·∫•t thanh to√°n</h1>
            <p>Ki·ªÉm tra th√¥ng tin v√† ho√†n t·∫•t thanh to√°n c·ªßa b·∫°n</p>
        </div>

        <div class="booking-summary" th:if="${booking}">
            <h3>üìã T√≥m t·∫Øt v√©</h3>
            <div class="info-row">
                <span class="info-label">M√£ v√©:</span>
                <span class="info-value" th:text="${bookingCode}">BK12345678</span>
            </div>
            <div class="info-row">
                <span class="info-label">H√†nh kh√°ch:</span>
                <span class="info-value" th:text="${booking.user.fullName}">John Doe</span>
            </div>
            <div class="info-row">
                <span class="info-label">Email:</span>
                <span class="info-value" th:text="${booking.user.email}">john@example.com</span>
            </div>
            <div class="info-row">
                <span class="info-label">SƒêT:</span>
                <span class="info-value" th:text="${booking.user.phone}">1234567890</span>
            </div>
            <div class="info-row">
                <span class="info-label">S·ªë l∆∞·ª£ng v√©:</span>
                <span class="info-value" th:text="${booking.tickets.size()}">2</span>
            </div>
            <div class="info-row">
                <span class="info-label">Tr·∫°ng th√°i:</span>
                <span class="info-value" th:text="${booking.status}">PENDING</span>
            </div>
        </div>

        <div class="total-amount" th:if="${booking}">
            T·ªïng c·ªông: <span th:text="${#numbers.formatDecimal(booking.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'"></span>
        </div>

        <div th:if="${booking == null}" class="error" style="display: block;">
            <h3>‚ùå Kh√¥ng t√¨m th·∫•y v√©</h3>
            <p>Kh√¥ng t√¨m th·∫•y th√¥ng tin v√© trong phi√™n l√†m vi·ªác. Vui l√≤ng <a href="/home">quay l·∫°i trang ch·ªß</a> v√† ƒë·∫∑t l·∫°i.</p>
        </div>

        <div th:if="${booking != null}">
            <button class="payment-button" onclick="completePayment()" id="paymentBtn">
                üí≥ Ho√†n t·∫•t thanh to√°n
            </button>
        </div>

        <div id="result" class="result"></div>
    </div>
</main>

<footer>
    <p>&copy; 2025 EVTrainTicket. All rights reserved.</p>
</footer>

<script>
    async function completePayment() {
        const button = document.getElementById('paymentBtn');
        const resultDiv = document.getElementById('result');

        // Disable button and show loading
        button.disabled = true;
        button.innerHTML = '‚è≥ ƒêang x·ª≠ l√Ω thanh to√°n...';

        resultDiv.style.display = 'block';
        resultDiv.className = 'result';
        resultDiv.innerHTML = '<div class="loading">ƒêang x·ª≠ l√Ω thanh to√°n c·ªßa b·∫°n...</div>';

        try {
            const response = await fetch('/api/payment/complete-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (response.ok && result.success) {
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                        <h3>‚úÖ Thanh to√°n th√†nh c√¥ng!</h3>
                        <p><strong>${result.message}</strong></p>
                        <div class="info-row">
                            <span class="info-label">M√£ v√©:</span>
                            <span class="info-value">${result.bookingCode}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Tr·∫°ng th√°i:</span>
                            <span class="info-value">${result.bookingStatus}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">V√© ƒë√£ k√≠ch ho·∫°t:</span>
                            <span class="info-value">${result.ticketCount}</span>
                        </div>
                        <div class="ticket-list">
                            <h4>üé´ V√© c·ªßa b·∫°n:</h4>
                            ${result.tickets.map(ticket => `
                                <div class="ticket-item">
                                    <strong>M√£ v√©:</strong> ${ticket.ticketCode}<br>
                                    <strong>Gh·∫ø:</strong> ${ticket.seatNumber}<br>
                                    <strong>Tr·∫°ng th√°i:</strong> ${ticket.status}<br>
                                    <strong>Gi√°:</strong> ${ticket.price.toLocaleString('vi-VN')} VNƒê
                                </div>
                            `).join('')}
                        </div>
                        <p><em>üéâ V√© c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t. Ch√∫c b·∫°n chuy·∫øn ƒëi vui v·∫ª!</em></p>
                        <button onclick="window.location.href='/home'" style="margin-top: 15px; padding: 10px 20px; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                            ƒê·∫∑t chuy·∫øn kh√°c
                        </button>
                    `;

                // Hide the payment button
                button.style.display = 'none';
            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                        <h3>‚ùå Thanh to√°n th·∫•t b·∫°i</h3>
                        <p>${result.error}</p>
                        <button onclick="retryPayment()" style="margin-top: 10px; padding: 8px 16px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Th·ª≠ l·∫°i
                        </button>
                    `;

                // Re-enable button
                button.disabled = false;
                button.innerHTML = 'üí≥ Ho√†n t·∫•t thanh to√°n';
            }
        } catch (error) {
            resultDiv.className = 'result error';
            resultDiv.innerHTML = `
                    <h3>‚ùå L·ªói</h3>
                    <p>ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω: ${error.message}</p>
                    <button onclick="retryPayment()" style="margin-top: 10px; padding: 8px 16px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Th·ª≠ l·∫°i
                    </button>
                `;

            // Re-enable button
            button.disabled = false;
            button.innerHTML = 'üí≥ Ho√†n t·∫•t thanh to√°n';
        }
    }

    function retryPayment() {
        const resultDiv = document.getElementById('result');
        resultDiv.style.display = 'none';
    }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch sử đặt vé - EV Train Ticket</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/booking-history.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>


<header>
    <nav class="navbar container">
        <a th:href="@{/home}" class="logo">
            <i class="fas fa-train"></i> EVTrainTicket
        </a>
        <div class="nav-links" th:if="${session.user == null}">
            <a th:href="@{/login}">Đăng nhập</a>
            <a th:href="@{/register}">Đăng ký</a>
        </div>

        <div class="user-info" th:if="${session.user != null}">
            <p>Xin chào, <strong th:text="${session.user.fullName}"></strong>!</p>

            <a th:href="@{/booking/history}" class="admin-nav-link" style="background-color: #28a745; border-color: #28a745;">
                <i class="fas fa-history"></i> Vé của tôi
            </a>

            <a th:if="${session.user.role == 'ADMIN'}" th:href="@{/admin}" class="admin-nav-link">
                <i class="fas fa-cogs"></i> Quản trị
            </a>

            <form th:action="@{/logout}" method="get" style="margin: 0;">
                <button type="submit">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </button>
            </form>
        </div>
    </nav>
</header>


<main>
    <div class="container main-container">

        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-history"></i> Vé của tôi</h2>
                    <a th:href="@{/home}" class="btn btn-primary"><i class="fas fa-plus"></i> Đặt vé mới</a>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <form th:action="@{/booking/history}" method="get" class="row">
                            <div class="col-md-3">
                                <label class="form-label">Trạng thái</label>
                                <select name="status" class="form-select">
                                    <option value="" th:selected="${selectedStatus == null}">Tất cả</option>
                                    <option value="CONFIRMED" th:selected="${selectedStatus == 'CONFIRMED'}">Đã xác nhận</option>
                                    <option value="PENDING" th:selected="${selectedStatus == 'PENDING'}">Đang chờ</option>
                                    <option value="CANCELLED" th:selected="${selectedStatus == 'CANCELLED'}">Đã hủy</option>
                                    <option value="COMPLETED" th:selected="${selectedStatus == 'COMPLETED'}">Đã hoàn tất</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Từ ngày</label>
                                <input type="date" name="fromDate" class="form-control" th:value="${selectedFromDate}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Đến ngày</label>
                                <input type="date" name="toDate" class="form-control" th:value="${selectedToDate}">
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-outline-primary me-2"><i class="fas fa-filter"></i> Lọc</button>
                                <a th:href="@{/booking/history}" class="btn btn-outline-secondary"><i class="fas fa-times"></i> Xóa</a>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="bookings-container">

                    <div th:if="${#lists.isEmpty(bookings)}" class="alert alert-info text-center">
                        <h5>Không tìm thấy vé nào</h5>
                        <p>Bạn chưa có lịch sử đặt vé hoặc không tìm thấy kết quả phù hợp.</p>
                    </div>

                    <div th:each="booking : ${bookings}" class="card booking-card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="journey-info">
                                        <div class="row" th:with="firstTicket=${booking.tickets[0]}">
                                            <div class="col-md-6">
                                                <h6 class="mb-1">
                                                    <i class="fas fa-train text-primary"></i>
                                                    <span th:text="${firstTicket.schedule.trainName}">Tàu SE1</span>
                                                </h6>
                                                <p class="mb-0">
                                                    <strong th:text="${firstTicket.schedule.origin}">Hanoi</strong>
                                                    <i class="fas fa-arrow-right mx-2"></i>
                                                    <strong th:text="${firstTicket.schedule.destination}">HCM</strong>
                                                </p>
                                                <small class="text-muted">
                                                    <span th:text="${#temporals.format(firstTicket.schedule.departureTime, 'dd/MM/yyyy HH:mm')}"></span>
                                                </small>
                                            </div>
                                            <div class="col-md-6">
                                                <p class="mb-1"><strong>Mã đặt vé:</strong> <span th:text="${booking.bookingCode}">BK123</span></p>
                                                <p class="mb-1"><strong>Số vé:</strong> <span th:text="${#lists.size(booking.tickets)} + ' ghế'"></span></p>
                                                <p class="mb-0"><strong>Tổng:</strong> <span class="text-success" th:text="${#numbers.formatDecimal(booking.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-4 text-end">
                                    <div class="mb-2">
                                        <span class="badge status-badge"
                                              th:text="${booking.status}"
                                              th:classappend="${booking.status == 'CONFIRMED' ? 'bg-success' :
                                                               (booking.status == 'CANCELLED' ? 'bg-danger' :
                                                               (booking.status == 'PENDING' ? 'bg-warning' : 'bg-primary'))}">
                                        </span>
                                    </div>
                                    <small class="text-muted d-block mb-2">
                                        Đặt ngày: <span th:text="${#temporals.format(booking.bookingDate, 'dd/MM/yyyy')}"></span>
                                    </small>

                                    <div th:id="'tickets-' + ${booking.bookingCode}" style="display: none;">
                                        <table class="table table-bordered table-sm table-hover mt-3">
                                            <thead class="table-light">
                                            <tr>
                                                <th>Mã vé</th>
                                                <th>Hành khách</th>
                                                <th>Loại vé</th>
                                                <th>Ghế</th>
                                                <th>Toa</th>
                                                <th>Giá vé</th>
                                                <th>Thanh toán</th>
                                                <th>Trạng thái</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="t : ${booking.tickets}">
                                                    <td th:text="${t.ticketCode}">TK01</td>
                                                    <td class="fw-bold text-dark" th:text="${t.passengerName}">Tên khách
                                                    </td>

                                                    <td>
                                                        <span class="badge bg-light text-dark border"
                                                              th:switch="${t.ticketType}">
                                                            <span th:case="'ADULT'">Người lớn</span>
                                                            <span th:case="'CHILD'">Trẻ em</span>
                                                            <span th:case="'ELDERLY'">Người cao tuổi</span>
                                                            <span th:case="*">[[${t.ticketType}]]</span>
                                                        </span>
                                                    </td>

                                                    <td class="fw-bold text-primary" th:text="${t.seatNumber}">1A</td>
                                                    <td th:text="${t.carriageName}">Toa 1</td>
                                                    <td th:text="${#numbers.formatDecimal(t.price, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></td>

                                                    <td>
                                                        <span class="badge bg-info text-dark"
                                                              th:if="${not #lists.isEmpty(booking.payments)}"
                                                              th:text="${booking.payments[0].paymentMethod}">
                                                        </span>

                                                        <span class="text-muted fst-italic"
                                                              style="font-size: 0.8rem;" th:if="${#lists.isEmpty(booking.payments)}">
                                                                 -
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="badge"
                                                              th:classappend="${t.status == 'ACTIVE' ? 'bg-success' :
                                                                             (t.status == 'CANCELLED' ? 'bg-danger' : 'bg-secondary')}"
                                                              th:text="${t.status}">
                                                        </span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <div class="btn-group-vertical">
                                        <button class="btn btn-outline-primary btn-sm view-details-btn"
                                                data-bs-toggle="modal"
                                                data-bs-target="#bookingModal"
                                                th:data-code="${booking.bookingCode}"
                                                th:data-status="${booking.status}"
                                                th:data-amount="${#numbers.formatDecimal(booking.totalAmount, 0, 'COMMA', 0, 'POINT')}"
                                                th:data-train="${booking.tickets[0].schedule.trainName}"
                                                th:data-origin="${booking.tickets[0].schedule.origin}"
                                                th:data-dest="${booking.tickets[0].schedule.destination}"
                                                th:data-time="${#temporals.format(booking.tickets[0].schedule.departureTime, 'dd/MM/yyyy HH:mm')}"
                                                th:data-ticket-source="'tickets-' + ${booking.bookingCode}"
                                                onclick="populateModal(this)">
                                            <i class="fas fa-eye"></i> Xem chi tiết
                                        </button>

                                        <form th:if="${booking.status == 'CONFIRMED' or booking.status == 'PENDING'}"
                                              th:action="@{/booking/cancel}" method="post"
                                              onsubmit="return confirm('Bạn có chắc chắn muốn hủy vé này không?');"
                                              style="display: inline;">
                                            <input type="hidden" name="bookingId" th:value="${booking.bookingId}">
                                            <button type="submit" class="btn btn-outline-danger btn-sm mt-1 w-100">
                                                <i class="fas fa-times"></i> Hủy vé
                                            </button>
                                        </form>

                                        <a th:if="${booking.status == 'PENDING'}"
                                           th:href="@{/payment(bookingCode=${booking.bookingCode})}"
                                           class="btn btn-success btn-sm mt-1">
                                            <i class="fas fa-credit-card"></i> Thanh toán
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-ticket-alt"></i> Chi tiết đặt vé: <span id="modalBookingCode"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-6">
                            <p><strong>Tàu:</strong> <span id="modalTrain"></span></p>
                            <p><strong>Hành trình:</strong> <span id="modalRoute"></span></p>
                        </div>
                        <div class="col-6">
                            <p><strong>Khởi hành:</strong> <span id="modalTime"></span></p>
                            <p><strong>Tổng tiền:</strong> <span id="modalAmount" class="text-success fw-bold"></span></p>
                        </div>
                    </div>

                    <h6 class="border-bottom pb-2"><i class="fas fa-list"></i> Danh sách vé</h6>
                    <div id="modalTicketContent">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="window.print()">In vé</button>
                </div>
            </div>
        </div>
    </div>
</main>

<footer class="site-footer">
    <div class="footer-container container">

        <div class="footer-column">
            <h3><i class="fas fa-train"></i> EVTrainTicket</h3>
            <p>Trải nghiệm hành trình an toàn, tiện lợi và đáng nhớ cùng đường sắt Việt Nam. Đặt vé ngay hôm nay!</p>
        </div>

        <div class="footer-column">
            <h4>Liên kết nhanh</h4>
            <ul>
                <li><a th:href="@{/home}"><i class="fas fa-home"></i> Trang chủ</a></li>
                <li><a th:href="@{/booking/history}"><i class="fas fa-history"></i> Vé của tôi</a></li>
                <li th:if="${session.user != null and session.user.role == 'ADMIN'}">
                    <a th:href="@{/admin}"><i class="fas fa-cogs"></i> Quản trị</a>
                </li>
            </ul>
        </div>

        <div class="footer-column">
            <h4>Liên hệ</h4>
            <ul>
                <li><i class="fas fa-map-marker-alt"></i> Lô E2a-7 - Đường D1 - Khu Công Nghệ Cao - TP. Thủ Đức - TP. HCM</li>
                <li><i class="fas fa-phone"></i> (024) 1234 5678</li>
                <li><i class="fas fa-envelope"></i> support@evtrainticket.vn</li>
            </ul>
        </div>

        <div class="footer-column">
            <h4>Theo dõi chúng tôi</h4>
            <div class="social-links">
                <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="#" aria-label="Youtube"><i class="fab fa-youtube"></i></a>
            </div>
        </div>
    </div>

    <div class="footer-bottom">
        <p>&copy; 2025 EVTrainTicket. All rights reserved.</p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function populateModal(button) {
        // 1. Read summary data
        const code = button.getAttribute('data-code');
        const train = button.getAttribute('data-train');
        const origin = button.getAttribute('data-origin');
        const dest = button.getAttribute('data-dest');
        const time = button.getAttribute('data-time');
        const amount = button.getAttribute('data-amount');

        // 2. Update Summary Text
        document.getElementById('modalBookingCode').textContent = code;
        document.getElementById('modalTrain').textContent = train;
        document.getElementById('modalRoute').textContent = origin + ' -> ' + dest;
        document.getElementById('modalTime').textContent = time;
        document.getElementById('modalAmount').textContent = amount + ' VNĐ';

        // 3. COPY TICKET LIST
        const sourceId = button.getAttribute('data-ticket-source');
        const sourceDiv = document.getElementById(sourceId);
        const targetDiv = document.getElementById('modalTicketContent');

        if (sourceDiv && targetDiv) {
            // Copy the HTML from the hidden div to the modal
            targetDiv.innerHTML = sourceDiv.innerHTML;
        } else {
            targetDiv.innerHTML = '<p class="text-muted">Không có thông tin chi tiết vé.</p>';
        }
    }
</script>

</body>
</html>
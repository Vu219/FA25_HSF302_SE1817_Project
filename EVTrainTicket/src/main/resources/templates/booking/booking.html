<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Đặt vé - EV Train Ticket</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/booking.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

<header>
    <nav class="navbar container">
        <a th:href="@{/home}" class="logo">
            <i class="fas fa-train"></i> EVTrainTicket
        </a>
        <div class="nav-links" th:if="${session.user == null}">
            <a th:href="@{/login}">Đăng nhập</a>
            <a th:href="@{/register}">Đăng ký</a>
        </div>

        <div class="user-info" th:if="${session.user != null}">
            <p>Xin chào, <strong th:text="${session.user.fullName}"></strong>!</p>

            <a th:href="@{/booking/history}" class="admin-nav-link" style="background-color: #28a745; border-color: #28a745;">
                <i class="fas fa-history"></i> Vé của tôi
            </a>

            <a th:if="${session.user.role == 'ADMIN'}" th:href="@{/admin}" class="admin-nav-link">
                <i class="fas fa-cogs"></i> Quản trị
            </a>

            <form th:action="@{/logout}" method="get" style="margin: 0;">
                <button type="submit">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </button>
            </form>
        </div>
    </nav>
</header>

<main class="booking-page-container">
    <div class="booking-left">
        <div class="booking-card">
            <div class="booking-card-header">
                <h4><i class="fas fa-chair"></i> Chọn chỗ ngồi của bạn</h4>
            </div>

            <div class="booking-card-body">
                <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

                <div th:unless="${error}" id="booking-content">
                    <div class="seat-legend">
                        <div><span class="seat available"></span> Có thể chọn</div>
                        <div><span class="seat selected"></span> Đã chọn</div>
                        <div><span class="seat booked"></span> Đã đặt</div>
                    </div>

                    <!-- Đã ẩn bằng CSS -->
                    <div class="selection-summary">
                        <p><strong>Ghế đã chọn:</strong> <span id="selected-count">0</span>/4 ghế</p>
                        <div id="selected-seats-list">Vui lòng chọn ghế</div>
                    </div>

                    <div th:if="${scheduleId == null}" class="text-center">
                        <h4>Vui lòng chọn chuyến tàu</h4>
                        <p>Hãy chọn một chuyến tàu từ <a th:href="@{/schedules}">danh sách lịch trình</a> để xem sơ đồ ghế</p>
                    </div>

                    <div th:if="${scheduleId != null}" id="carriages-container">
                        <form id="seat-selection-form" method="post" th:action="@{/booking/select-seats}">
                            <input type="hidden" name="scheduleId" th:value="${scheduleId}"/>

                            <div th:if="${carriageLayouts != null}">
                                <div th:each="carriage : ${carriageLayouts}" class="carriage-section">
                                    <h6 th:text="${carriage.carriageNumber + ' - ' + carriage.carriageTypeName + ' (' + carriage.totalSeats + ' ghế)'}">
                                        Toa 1 - Loại toa (60 ghế)
                                    </h6>

                                    <div class="seat-map">
                                        <div th:each="rowEntry : ${carriage.seatsByRow}" class="seat-row-container">
                                            <div class="row-label" th:text="'Hàng ' + ${rowEntry.key}">Hàng 1</div>
                                            <div class="seat-row">

                                                <div class="seat-group">
                                                    <div th:each="seat : ${rowEntry.value}"
                                                         th:if="${seat.columnNum != null and seat.columnNum <= 2}"
                                                         class="seat-container">

                                                        <div th:if="${seat.status.name() == 'AVAILABLE'}" class="seat-input-container">
                                                            <input type="checkbox"
                                                                   th:id="'seat-' + ${seat.seatID}"
                                                                   name="selectedSeats"
                                                                   th:value="${seat.seatID}"
                                                                   th:attr="data-seat-number=${seat.seatNumber},
                                                                           data-price=${seat.price},
                                                                           data-carriage=${seat.carriageNumber},
                                                                           data-seat-type=${seat.seatTypeName}"
                                                                   class="seat-checkbox"/>
                                                            <label th:for="'seat-' + ${seat.seatID}"
                                                                   class="seat available selectable"
                                                                   th:title="${seat.seatNumber + ' - ' + seat.seatTypeName + ' - ' + seat.price + ' VNĐ'}">
                                                                <span th:text="${seat.seatNumber}">01</span>
                                                                <span class="seat-price" th:text="${#numbers.formatDecimal(seat.price, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}"></span>
                                                            </label>
                                                        </div>

                                                        <div th:if="${seat.status.name() == 'BOOKED'}" class="seat booked"
                                                             th:title="${seat.seatNumber + ' - Đã đặt'}">
                                                            <span th:text="${seat.seatNumber}">01</span>
                                                            <span class="seat-price" th:text="${#numbers.formatDecimal(seat.price, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}"></span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="aisle"></div>

                                                <div class="seat-group">
                                                    <div th:each="seat : ${rowEntry.value}"
                                                         th:if="${seat.columnNum != null and seat.columnNum > 2}"
                                                         class="seat-container">

                                                        <div th:if="${seat.status.name() == 'AVAILABLE'}" class="seat-input-container">
                                                            <input type="checkbox"
                                                                   th:id="'seat-' + ${seat.seatID}"
                                                                   name="selectedSeats"
                                                                   th:value="${seat.seatID}"
                                                                   th:attr="data-seat-number=${seat.seatNumber},
                                                                           data-price=${seat.price},
                                                                           data-carriage=${seat.carriageNumber},
                                                                           data-seat-type=${seat.seatTypeName}"
                                                                   class="seat-checkbox"/>
                                                            <label th:for="'seat-' + ${seat.seatID}"
                                                                   class="seat available selectable"
                                                                   th:title="${seat.seatNumber + ' - ' + seat.seatTypeName + ' - ' + seat.price + ' VNĐ'}">
                                                                <span th:text="${seat.seatNumber}">03</span>
                                                                <span class="seat-price" th:text="${#numbers.formatDecimal(seat.price, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}"></span>
                                                            </label>
                                                        </div>

                                                        <div th:if="${seat.status.name() == 'BOOKED'}" class="seat booked"
                                                             th:title="${seat.seatNumber + ' - Đã đặt'}">
                                                            <span th:text="${seat.seatNumber}">03</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="booking-right">
        <div class="booking-card" id="schedule-info-card">
            <div class="booking-card-header">
                <h4><i class="fas fa-train"></i> Thông tin chuyến tàu</h4>
            </div>
            <div class="booking-card-body">
                <div class="schedule-info-box">
                    <div class="info-row">
                        <strong>Chuyến tàu:</strong>
                        <span th:text="${schedule != null ? schedule.train.trainName : '-'}">-</span>
                    </div>
                    <div class="info-row">
                        <strong>Từ:</strong>
                        <span th:text="${schedule != null ? schedule.departureStation.name : '-'}">-</span>
                    </div>
                    <div class="info-row">
                        <strong>Đến:</strong>
                        <span th:text="${schedule != null ? schedule.arrivalStation.name : '-'}">-</span>
                    </div>
                    <div class="info-row">
                        <strong>Khởi hành:</strong>
                        <span th:text="${schedule != null ? #temporals.format(schedule.departureTime, 'dd/MM/yyyy HH:mm') : '-'}">-</span>
                    </div>
                    <div class="info-row">
                        <strong>Đến nơi:</strong>
                        <span th:text="${schedule != null ? #temporals.format(schedule.arrivalTime, 'dd/MM/yyyy HH:mm') : '-'}">-</span>
                    </div>

                    <div th:if="${totalSeats != null}">
                        <hr style="border-style: dashed; margin: 15px 0;">
                        <div class="info-row">
                            <strong>Tổng ghế:</strong>
                            <span th:text="${totalSeats}">0</span>
                        </div>
                        <div class="info-row">
                            <strong>Còn trống:</strong>
                            <span th:text="${availableSeats}" style="color: #28a745; font-weight: bold;">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="booking-card" id="booking-summary">
            <div class="booking-card-header">
                <h4><i class="fas fa-receipt"></i> Tóm tắt đặt vé</h4>
            </div>
            <div class="booking-card-body">
                <div id="summary-content">
                    <div class="summary-item">
                        <strong>Chuyến tàu</strong>
                        <span id="summary-train-name" th:text="${schedule != null ? schedule.train.trainName : 'Vui lòng chọn chuyến tàu...'}">...</span>
                    </div>
                    <div class="summary-item">
                        <strong>Hành trình</strong>
                        <span id="summary-route" th:text="${schedule != null ? (schedule.departureStation.name + ' → ' + schedule.arrivalStation.name) : '-'}">-</span>
                    </div>
                    <div class="summary-item" style="flex-direction: column; align-items: stretch;">
                        <strong style="margin-bottom: 10px;">Ghế đã chọn</strong>
                        <div id="summary-seats-list">
                            <p class="text-muted" style="text-align: center; padding: 20px;">Chưa chọn ghế nào</p>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="total-amount-section">
                    <strong>Tổng cộng:</strong>
                    <strong id="total-amount">0 VNĐ</strong>
                </div>

                <div class="booking-navigation">
                    <button type="submit" form="seat-selection-form" class="btn btn-primary" id="next-btn" disabled>
                        Tiếp theo <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>

<footer class="site-footer">
    <div class="footer-container container">

        <div class="footer-column">
            <h3><i class="fas fa-train"></i> EVTrainTicket</h3>
            <p>Trải nghiệm hành trình an toàn, tiện lợi và đáng nhớ cùng đường sắt Việt Nam. Đặt vé ngay hôm nay!</p>
        </div>

        <div class="footer-column">
            <h4>Liên kết nhanh</h4>
            <ul>
                <li><a th:href="@{/home}"><i class="fas fa-home"></i> Trang chủ</a></li>
                <li><a th:href="@{/booking/history}"><i class="fas fa-history"></i> Vé của tôi</a></li>
                <li th:if="${session.user != null and session.user.role == 'ADMIN'}">
                    <a th:href="@{/admin}"><i class="fas fa-cogs"></i> Quản trị</a>
                </li>
            </ul>
        </div>

        <div class="footer-column">
            <h4>Liên hệ</h4>
            <ul>
                <li><i class="fas fa-map-marker-alt"></i> Lô E2a-7 - Đường D1 - Khu Công Nghệ Cao - TP. Thủ Đức - TP. HCM</li>
                <li><i class="fas fa-phone"></i> (024) 1234 5678</li>
                <li><i class="fas fa-envelope"></i> support@evtrainticket.vn</li>
            </ul>
        </div>

        <div class="footer-column">
            <h4>Theo dõi chúng tôi</h4>
            <div class="social-links">
                <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="#" aria-label="Youtube"><i class="fab fa-youtube"></i></a>
            </div>
        </div>
    </div>

    <div class="footer-bottom">
        <p>&copy; 2025 EVTrainTicket. All rights reserved.</p>
    </div>
</footer>
<script th:src="@{/js/booking.js}"></script>

</body>
</html>
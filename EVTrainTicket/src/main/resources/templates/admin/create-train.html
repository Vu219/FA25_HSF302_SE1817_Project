<section>
    <div class="form-container">
        <h2><i class="fas fa-edit"></i> T·∫°o t√†u m·ªõi</h2>
        <form th:action="@{/admin/train/create}" th:object="${train}" method="post" style="margin-top: 20px;">
            <input type="hidden" id="trainID" th:field="*{trainID}">

            <div class="form-group">
                <label for="trainNumber">S·ªë t√†u: <span style="color: red;">*</span></label>
                <input type="text" id="trainNumber" th:field="*{trainNumber}" required
                       placeholder="V√≠ d·ª•: SE1, SE2...">
            </div>

            <div class="form-group">
                <label for="trainName">T√™n t√†u: <span style="color: red;">*</span></label>
                <input type="text" id="trainName" th:field="*{trainName}" required
                       placeholder="V√≠ d·ª•: Th·ªëng Nh·∫•t, S√†i G√≤n...">
            </div>

            <div class="form-group">
                <label for="capacity">S·ª©c ch·ª©a: <span style="color: red;">*</span></label>
                <input type="number" id="capacity" th:field="*{capacity}" required min="1"
                       placeholder="S·ªë l∆∞·ª£ng h√†nh kh√°ch t·ªëi ƒëa">
            </div>

            <div class="form-group">
                <label for="status">Tr·∫°ng th√°i: <span style="color: red;">*</span></label>
                <select id="status" th:field="*{status}">
                    <option value="Ho·∫°t ƒë·ªông">Ho·∫°t ƒë·ªông</option>
                    <option value="Kh√¥ng ho·∫°t ƒë·ªông">Kh√¥ng ho·∫°t ƒë·ªông</option>
                    <option value="B·∫£o tr√¨">B·∫£o tr√¨</option>
                </select>
            </div>

            <div class="schedule-section" id="schedule1-section">
                <div class="schedule-label">üìç L·ªãch tr√¨nh 1:</div>
                <div class="form-group">
                    <select id="schedule1" name="scheduleIds[]" class="schedule-dropdown">
                        <option value="">Ch·ªçn l·ªãch tr√¨nh cho t√†u</option>
                        <option th:each="s : ${scheduleList}"
                                th:value="${s.scheduleID}"
                                th:text="|${s.departureStation.name} ‚Üí ${s.arrivalStation.name} (${#temporals.format(s.departureTime, 'dd/MM/yyyy HH:mm')} - ${#temporals.format(s.arrivalTime, 'dd/MM/yyyy HH:mm')})|"
                                th:data-departure-station="${s.departureStation.stationID}"
                                th:data-arrival-station="${s.arrivalStation.stationID}"
                                th:data-departure-time="${s.departureTime}"
                                th:data-arrival-time="${s.arrivalTime}"
                                th:data-departure-name="${s.departureStation.name}"
                                th:data-arrival-name="${s.arrivalStation.name}">
                        </option>
                    </select>
                </div>
            </div>

            <div class="schedule-section" id="schedule2-section" style="display: none;">
                <div class="schedule-label">üìç L·ªãch tr√¨nh 2:</div>
                <div class="form-group">
                    <select id="schedule2" name="scheduleIds[]" class="schedule-dropdown" disabled>
                        <option value="">Ch·ªçn l·ªãch tr√¨nh cho t√†u</option>
                        <option th:each="s : ${scheduleList}"
                                th:value="${s.scheduleID}"
                                th:text="|${s.departureStation.name} ‚Üí ${s.arrivalStation.name} (${#temporals.format(s.departureTime, 'dd/MM/yyyy HH:mm')} - ${#temporals.format(s.arrivalTime, 'dd/MM/yyyy HH:mm')})|"
                                th:data-departure-station="${s.departureStation.stationID}"
                                th:data-arrival-station="${s.arrivalStation.stationID}"
                                th:data-departure-time="${s.departureTime}"
                                th:data-arrival-time="${s.arrivalTime}"
                                th:data-departure-name="${s.departureStation.name}"
                                th:data-arrival-name="${s.arrivalStation.name}">
                        </option>
                    </select>
                </div>
            </div>

            <div class="schedule-section" id="schedule3-section" style="display: none;">
                <div class="schedule-label">üìç L·ªãch tr√¨nh 3:</div>
                <div class="form-group">
                    <select id="schedule3" name="scheduleIds[]" class="schedule-dropdown" disabled>
                        <option value="">Ch·ªçn l·ªãch tr√¨nh cho t√†u</option>
                        <option th:each="s : ${scheduleList}"
                                th:value="${s.scheduleID}"
                                th:text="|${s.departureStation.name} ‚Üí ${s.arrivalStation.name} (${#temporals.format(s.departureTime, 'dd/MM/yyyy HH:mm')} - ${#temporals.format(s.arrivalTime, 'dd/MM/yyyy HH:mm')})|"
                                th:data-departure-station="${s.departureStation.stationID}"
                                th:data-arrival-station="${s.arrivalStation.stationID}"
                                th:data-departure-time="${s.departureTime}"
                                th:data-arrival-time="${s.arrivalTime}"
                                th:data-departure-name="${s.departureStation.name}"
                                th:data-arrival-name="${s.arrivalStation.name}">
                        </option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="notes">Ghi ch√∫:</label>
                <textarea id="notes" th:field="*{notes}" rows="3"
                          placeholder="Th√¥ng tin th√™m v·ªÅ t√†u..."></textarea>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Th√™m t√†u
                </button>
                <a th:href="@{/admin/train}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> H·ªßy
                </a>
            </div>
        </form>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const schedule1 = document.getElementById('schedule1');
        const schedule2 = document.getElementById('schedule2');
        const schedule3 = document.getElementById('schedule3');

        const section2 = document.getElementById('schedule2-section');
        const section3 = document.getElementById('schedule3-section');

        schedule1.addEventListener('change', function() {
            if (this.value) {
                section2.style.display = 'block';
                schedule2.disabled = false;
                document.getElementById('schedule1-section').classList.add('filled');
                filterSchedule2Options();

            } else {
                section2.style.display = 'none';
                section3.style.display = 'none';
                schedule2.disabled = true;
                schedule3.disabled = true;
                schedule2.value = '';
                schedule3.value = '';
                document.getElementById('schedule1-section').classList.remove('filled');
                document.getElementById('schedule2-section').classList.remove('filled');
                document.getElementById('schedule3-section').classList.remove('filled');
            }
        });

        schedule2.addEventListener('change', function() {
            if (this.value) {
                if (!validateScheduleChain(schedule1, schedule2)) {
                    alert('L·ªói: Ga ƒë·∫øn c·ªßa l·ªãch tr√¨nh 1 ph·∫£i tr√πng v·ªõi ga kh·ªüi h√†nh c·ªßa l·ªãch tr√¨nh 2!');
                    this.value = '';
                    return;
                }

                if (!validateScheduleTime(schedule1, schedule2)) {
                    alert('L·ªói: Th·ªùi gian kh·ªüi h√†nh c·ªßa l·ªãch tr√¨nh 2 ph·∫£i sau th·ªùi gian ƒë·∫øn c·ªßa l·ªãch tr√¨nh 1!');
                    this.value = '';
                    return;
                }

                section3.style.display = 'block';
                schedule3.disabled = false;
                document.getElementById('schedule2-section').classList.add('filled');
                filterSchedule3Options();

            } else {
                section3.style.display = 'none';
                schedule3.disabled = true;
                schedule3.value = '';
                document.getElementById('schedule2-section').classList.remove('filled');
                document.getElementById('schedule3-section').classList.remove('filled');
            }
        });

        schedule3.addEventListener('change', function() {
            if (this.value) {
                if (!validateScheduleChain(schedule2, schedule3)) {
                    alert('L·ªói: Ga ƒë·∫øn c·ªßa l·ªãch tr√¨nh 2 ph·∫£i tr√πng v·ªõi ga kh·ªüi h√†nh c·ªßa l·ªãch tr√¨nh 3!');
                    this.value = '';
                    return;
                }

                if (!validateScheduleTime(schedule2, schedule3)) {
                    alert('L·ªói: Th·ªùi gian kh·ªüi h√†nh c·ªßa l·ªãch tr√¨nh 3 ph·∫£i sau th·ªùi gian ƒë·∫øn c·ªßa l·ªãch tr√¨nh 2!');
                    this.value = '';
                    return;
                }

                document.getElementById('schedule3-section').classList.add('filled');
            } else {
                document.getElementById('schedule3-section').classList.remove('filled');
            }
        });

        function filterSchedule2Options() {
            const selectedOption1 = schedule1.options[schedule1.selectedIndex];
            const arrivalStation1 = selectedOption1.getAttribute('data-arrival-station');

            Array.from(schedule2.options).forEach(option => {
                if (option.value === '') return; // Skip placeholder

                const departureStation = option.getAttribute('data-departure-station');
                if (departureStation === arrivalStation1 && option.value !== schedule1.value) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        function filterSchedule3Options() {
            const selectedOption2 = schedule2.options[schedule2.selectedIndex];
            const arrivalStation2 = selectedOption2.getAttribute('data-arrival-station');

            Array.from(schedule3.options).forEach(option => {
                if (option.value === '') return; // Skip placeholder

                const departureStation = option.getAttribute('data-departure-station');
                if (departureStation === arrivalStation2 &&
                    option.value !== schedule1.value &&
                    option.value !== schedule2.value) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        function validateScheduleChain(prevSelect, nextSelect) {
            const prevOption = prevSelect.options[prevSelect.selectedIndex];
            const nextOption = nextSelect.options[nextSelect.selectedIndex];

            const prevArrival = prevOption.getAttribute('data-arrival-station');
            const nextDeparture = nextOption.getAttribute('data-departure-station');

            return prevArrival === nextDeparture;
        }

        function validateScheduleTime(prevSelect, nextSelect) {
            const prevOption = prevSelect.options[prevSelect.selectedIndex];
            const nextOption = nextSelect.options[nextSelect.selectedIndex];

            const prevArrivalTime = new Date(prevOption.getAttribute('data-arrival-time'));
            const nextDepartureTime = new Date(nextOption.getAttribute('data-departure-time'));

            return nextDepartureTime > prevArrivalTime;
        }
    });
</script>
<div class="admin-form-container form-container">
    <h2 style="margin-bottom: 25px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">
        <i th:class="${schedule.scheduleID == null ? 'fas fa-plus-circle' : 'fas fa-edit'}"></i>
        <span th:text="${schedule.scheduleID == null ? 'Tạo Lịch trình mới' : 'Chỉnh sửa Lịch trình'}"></span>
    </h2>

    <form th:action="${schedule.scheduleID == null ? '/admin/schedules/create' : '/admin/schedules/edit/' + schedule.scheduleID}"
          method="post">

        <h3 style="color: var(--admin-primary); margin: 20px 0 15px 0;">
            <i class="fas fa-info-circle"></i> Thông tin cơ bản
        </h3>

        <div class="form-grid">

            <div class="form-group">
                <label for="stopDuration">

        <h3 style="color: var(--admin-primary); margin: 30px 0 15px 0;">
            <i class="fas fa-map-marked-alt"></i> Thông tin Tuyến
        </h3>

        <div class="form-grid">
            <div class="form-group">
                <label for="departureStation">
                    <i class="fas fa-map-marker-alt" style="color: #28a745;"></i> Ga đi <span>*</span>
                </label>
                <select id="departureStation" name="departureStationId" class="form-control" required onchange="updateRouteData()">
                    <option value="">Chọn Ga đi...</option>
                    <option th:each="station : ${stations}"
                            th:value="${station.stationID}"
                            th:text="${station.name}"
                            th:selected="${schedule.departureStation != null and schedule.departureStation.stationID == station.stationID}">
                    </option>
                </select>
            </div>

            <div class="form-group">
                <label for="arrivalStation">
                    <i class="fas fa-map-marker-alt" style="color: #dc3545;"></i> Ga đến <span>*</span>
                </label>
                <select id="arrivalStation" name="arrivalStationId" class="form-control" required onchange="updateRouteData()">
                    <option value="">Chọn Ga đến...</option>
                    <option th:each="station : ${stations}"
                            th:value="${station.stationID}"
                            th:text="${station.name}"
                            th:selected="${schedule.arrivalStation != null and schedule.arrivalStation.stationID == station.stationID}">
                    </option>
                </select>
            </div>
        </div>

        <div id="routeDetails" style="display: none; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid var(--admin-primary);">
            <div class="form-grid">
                <div class="form-group">
                    <label for="distanceDisplay">
                        <i class="fas fa-road"></i> Cự ly (km)
                    </label>
                    <input type="text" id="distanceDisplay" class="form-control" readonly style="background: #f3e5f5;">
                </div>

                <div class="form-group">
                    <label for="durationDisplay">
                        <i class="fas fa-hourglass-half"></i> Thời gian chạy
                    </label>
                    <input type="text" id="durationDisplay" class="form-control" readonly style="background: #fff3e0;">
                </div>
            </div>
        </div>

        <!-- Hidden inputs để submit data -->
        <input type="hidden" id="distanceKm" name="distanceKm">
        <input type="hidden" id="estimatedTime" name="estimatedTime">
        <input type="hidden" id="routeId" name="route.id">

        <h3 style="color: var(--admin-primary); margin: 30px 0 15px 0;">
            <i class="fas fa-clock"></i> Thời gian
        </h3>

        <div class="form-grid">
            <div class="form-group">
                <label for="stopDuration">
                    <i class="fas fa-pause-circle"></i> Thời gian dừng (phút) <span>*</span>
                </label>
                <select id="stopDuration" name="stopDuration" class="form-control" required onchange="calculateArrivalTime()">
                    <option value="">Chọn thời gian dừng...</option>
                    <option value="5" th:selected="${schedule.stopDuration == 5}">5 phút</option>
                    <option value="10" th:selected="${schedule.stopDuration == 10}">10 phút</option>
                    <option value="15" th:selected="${schedule.stopDuration == 15}">15 phút</option>
                </select>
            </div>
        </div>
            <div class="form-group">
                <label for="departureDate">
                    <i class="fas fa-calendar-day"></i> Ngày đi <span>*</span>
                </label>
                <input type="date"
                       id="departureDate"
                       name="departureDate"
                       th:value="${schedule.departureTime != null ? #temporals.format(schedule.departureTime, 'yyyy-MM-dd') : ''}"
                       class="form-control"
                       onchange="calculateArrivalTime()"
                       required>
            </div>

            <div class="form-group">
                <label for="departureTime">
                    <i class="fas fa-clock"></i> Giờ đi <span>*</span>
                </label>
                <input type="time"
                       id="departureTime"
                       name="departureTime"
                       th:value="${schedule.departureTime != null ? #temporals.format(schedule.departureTime, 'HH:mm') : ''}"
                       class="form-control"
                       onchange="calculateArrivalTime()"
                       required>
            </div>

            <div class="form-group">
                <label for="arrivalDate">
                    <i class="fas fa-calendar-check"></i> Ngày đến
                </label>
                <input type="date"
                       id="arrivalDate"
                       name="arrivalDate"
                       class="form-control"
                       readonly
                       style="background: #f0f0f0;">
            </div>

            <div class="form-group">
                <label for="arrivalTime">
                    <i class="fas fa-clock"></i> Giờ đến
                </label>
                <input type="time"
                       id="arrivalTime"
                       name="arrivalTime"
                       class="form-control"
                       readonly
                       style="background: #f0f0f0;">
            </div>
        </div>

        <h3 style="color: var(--admin-primary); margin: 30px 0 15px 0;">
            <i class="fas fa-dollar-sign"></i> Giá vé
        </h3>

        <div class="form-grid">
            <div class="form-group">
                <label for="basePriceDisplay">
                    <i class="fas fa-money-bill-wave"></i> Giá cơ bản (VNĐ) <span>*</span>
                </label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div id="basePriceDisplay" class="form-control" style="background: #f0f0f0; display: flex; align-items: center; padding: 10px; border-radius: 4px; min-height: 38px;">
                        <span id="basePriceValue" style="font-weight: bold; color: #28a745;">Chọn tuyến để tính giá</span>
                    </div>
                    <!-- Hidden input để submit giá trị thực -->
                    <input type="hidden" id="basePrice" name="basePrice" th:value="${schedule.basePrice}">
                    <span style="color: #666; font-size: 0.9em; white-space: nowrap;">
                        <i class="fas fa-info-circle"></i> = km × 700 VNĐ
                    </span>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-success">
                <i class="fas fa-save"></i> Lưu Lịch trình
            </button>
            <a th:href="@{/admin/schedules}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Hủy
            </a>
        </div>
    </form>
</div>

<script>
    const PRICE_PER_KM = 700;
    const DEFAULT_TRAIN_SPEED_KMPH = 60;  // km/h default

    // Store train speeds data on page load
    let trainSpeedsMap = {};

    // Convert minutes to readable format (e.g., 270 -> "4 giờ 30 phút")
    function formatDuration(minutes) {
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;

        if (hours === 0) {
            return `${mins} phút`;
        } else if (mins === 0) {
            return `${hours} giờ`;
        } else {
            return `${hours} giờ ${mins} phút`;
        }
    }

    /**
     * Get train speed from selected train
     */
    function getSelectedTrainSpeed() {
        const trainSelect = document.querySelector('select[name="train.id"]');
        if (!trainSelect || !trainSelect.value) {
            return DEFAULT_TRAIN_SPEED_KMPH;
        }

        const selectedOption = trainSelect.options[trainSelect.selectedIndex];
        let trainSpeed = parseFloat(selectedOption.dataset.speed);

        if (isNaN(trainSpeed) || trainSpeed <= 0) {
            trainSpeed = DEFAULT_TRAIN_SPEED_KMPH;
        }

        return trainSpeed;
    }

    /**
     * Tính giờ đến tự động
     * Công thức:
     *   - travel_time = distance_km / train_speed_kmph
     *   - stop_time = stopDuration (5, 10, 15)
     *   - arrival_time = departure_time + travel_time + stop_time
     */
    function calculateArrivalTime() {
        const depDateInput = document.getElementById('departureDate').value;
        const depTimeInput = document.getElementById('departureTime').value;
        const distanceKm = parseFloat(document.getElementById('distanceKm').value) || 0;
        const stopDurationInput = document.getElementById('stopDuration').value;

        if (!depDateInput || !depTimeInput || distanceKm <= 0 || !stopDurationInput) {
            document.getElementById('arrivalDate').value = '';
            document.getElementById('arrivalTime').value = '';
            document.getElementById('durationDisplay').value = '';
            return;
        }

        // Lấy vận tốc tàu từ dropdown train đã chọn
        const trainSpeed = getSelectedTrainSpeed();
        const stopDurationMinutes = parseInt(stopDurationInput) || 0;

        try {
            // Tạo departure datetime
            const depDateTime = new Date(`${depDateInput}T${depTimeInput}`);

            // Tính thời gian chạy (phút)
            const travelMinutes = (distanceKm / trainSpeed) * 60;

            // Tổng thời gian = chạy + dừng
            const totalMinutes = travelMinutes + stopDurationMinutes;

            // Tính arrival datetime
            const arrDateTime = new Date(depDateTime.getTime() + totalMinutes * 60000);

            // Format output
            const arrDate = arrDateTime.toISOString().split('T')[0];  // YYYY-MM-DD
            const arrTime = String(arrDateTime.getHours()).padStart(2, '0') + ':' +
                           String(arrDateTime.getMinutes()).padStart(2, '0');  // HH:MM

            document.getElementById('arrivalDate').value = arrDate;
            document.getElementById('arrivalTime').value = arrTime;

            // Update duration display: thời gian chạy + thời gian dừng
            document.getElementById('durationDisplay').value = formatDuration(Math.round(travelMinutes)) +
                ' + ' + stopDurationMinutes + ' phút dừng = ' + formatDuration(Math.round(totalMinutes)) +
                ' (' + Math.round(totalMinutes) + ' phút)';

            // Store estimated time in hidden input
            document.getElementById('estimatedTime').value = Math.round(travelMinutes);

        } catch (error) {
            console.error('Error calculating arrival time:', error);
        }
    }

    async function updateRouteData() {
        const depStationId = parseInt(document.getElementById('departureStation').value);
        const arrStationId = parseInt(document.getElementById('arrivalStation').value);

        if (!depStationId || !arrStationId) {
            document.getElementById('routeDetails').style.display = 'none';
            clearRouteData();
            return;
        }

        if (depStationId === arrStationId) {
            alert('Ga đi và ga đến không được trùng nhau!');
            document.getElementById('arrivalStation').value = '';
            clearRouteData();
            return;
        }

        try {
            // Gọi API tính distance
            const response = await fetch(`/api/routes/distance?fromStationId=${depStationId}&toStationId=${arrStationId}`);
            const data = await response.json();

            if (data.error) {
                alert('❌ ' + data.error);
                document.getElementById('arrivalStation').value = '';
                clearRouteData();
                return;
            }

            // Update displays
            document.getElementById('routeDetails').style.display = 'block';
            document.getElementById('distanceDisplay').value = data.distance_km + ' km' +
                (data.isIndirect ? ' (gián tiếp)' : ' (trực tiếp)');

            // Update hidden inputs - IMPORTANT: Store numeric value, not formatted
            document.getElementById('distanceKm').value = data.distance_km;
            if (data.routeId) {
                document.getElementById('routeId').value = data.routeId;
            }

            // Calculate and store price
            const basePrice = Math.round(data.distance_km * PRICE_PER_KM);
            document.getElementById('basePrice').value = basePrice;  // Store numeric value for submission
            document.getElementById('basePriceValue').textContent = basePrice.toLocaleString('vi-VN') + ' VNĐ';  // Display formatted

            // ✨ Auto-calculate arrival time khi route thay đổi
            calculateArrivalTime();

        } catch (error) {
            console.error('Error:', error);
            alert('⚠️ Lỗi khi tính toán tuyến đường');
            clearRouteData();
        }
    }

    function clearRouteData() {
        document.getElementById('routeDetails').style.display = 'none';
        document.getElementById('distanceKm').value = '';
        document.getElementById('estimatedTime').value = '';
        document.getElementById('routeId').value = '';
        document.getElementById('basePrice').value = '';
        document.getElementById('basePriceValue').textContent = 'Chọn tuyến để tính giá';
        document.getElementById('durationDisplay').value = '';
        document.getElementById('arrivalDate').value = '';
        document.getElementById('arrivalTime').value = '';
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', function() {
        // Check if schedule was pre-selected (edit mode)
        if (document.getElementById('departureStation').value &&
            document.getElementById('arrivalStation').value) {
            updateRouteData();
        }

        // If basePrice already has a value (edit mode), display it
        const basePriceValue = document.getElementById('basePrice').value;
        if (basePriceValue) {
            document.getElementById('basePriceValue').textContent = parseInt(basePriceValue).toLocaleString('vi-VN') + ' VNĐ';
        }
    });

    // Add change listener to train select to recalculate times if train changes
    document.addEventListener('DOMContentLoaded', function() {
        const trainSelect = document.querySelector('select[name="train.id"]');
        if (trainSelect) {
            trainSelect.addEventListener('change', function() {
                // Recalculate arrival time when train speed might change
                calculateArrivalTime();
            });
        }
    });
</script>

